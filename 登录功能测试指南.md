# 🧪 微信登录功能测试指南

## 📋 快速开始

### 前置准备

1. **后端服务已启动**（如未启动，执行下面命令）
```bash
cd D:\project\szbz
mvn spring-boot:run
```

2. **微信开发者工具已打开**
   - 项目目录: `d:\project\szbzMiniApp`
   - 已关闭域名校验

---

## 🎯 测试场景

### 场景1: 首次登录测试

**目的**: 验证首次点击按钮时的完整登录流程

#### 操作步骤

1. **清空所有缓存**
   ```javascript
   // 微信开发者工具控制台执行
   wx.clearStorageSync()
   console.log('缓存已清空')
   ```

2. **刷新页面**
   - 点击开发者工具的刷新按钮
   - 或按 `Ctrl + R`

3. **填写表单数据**
   ```
   性别: 男
   出生年份: 2014年
   出生月份: 6月
   出生日期: 15日
   出生时辰: 午时 (11:00-12:59)
   ```

4. **打开控制台Console**
   - 点击底部 `Console` 标签

5. **点击"照见本心"按钮**

#### 预期结果

**✅ 控制台应该显示：**
```
[Index] ========== 点击提交按钮 ==========
[Index] 步骤1: 开始登录流程
[Auth] ========== 开始登录流程 ==========
[Auth] 用户未登录或登录已过期
[Auth] 开始调用wx.login获取新的code
[Auth] 获取code成功: 071xxxxxxxxxxxxx
[Auth] code已缓存，有效期4分钟
[Auth] 登录状态已保存
[Auth] ========== 登录流程完成 ==========
[Index] 登录成功，获取到code: 071xxxxxxxxxxxxx
[Index] 步骤2: 时辰转换完成，午时 → 11时
[Index] 步骤3: 准备跳转到info页面
[Index] 传递参数: code=071xxx, gender=male, year=2014...
[Index] 页面跳转成功
[Index] ========== 提交流程完成 ==========
```

**✅ 页面行为：**
- 显示 "登录中..." 加载提示（约1秒）
- 自动跳转到info页面
- 显示 "正在分析中..." 加载动画
- 1-3秒后显示八字分析结果

**✅ Storage应该有：**
打开 `Storage` 面板，应该看到：
```
wx_login_code: "071xxxxxxxxxxxxx"
wx_login_code_timestamp: 1734422400000
wx_login_state: {timestamp: 1734422400000, isLoggedIn: true}
```

**✅ Network面板：**
- 看到 POST 请求到 `/api/bazi/analyze`
- Request Payload包含 `code` 字段
- Response返回200状态码

#### ❌ 常见问题

**问题1**: 控制台显示"code或openId不能为空"
- **原因**: code未正确传递
- **解决**: 检查页面跳转URL中是否包含code参数

**问题2**: 一直显示"登录中..."
- **原因**: wx.login调用失败
- **解决**: 检查网络连接，查看控制台错误信息

---

### 场景2: 缓存code测试（4分钟内）

**目的**: 验证code缓存机制，用户无感知登录

#### 操作步骤

1. **完成场景1的首次登录**

2. **立即返回首页**
   - 点击左上角返回按钮
   - 或点击底部tab切换

3. **再次点击"照见本心"按钮**
   - 无需修改表单数据
   - 直接点击

#### 预期结果

**✅ 控制台应该显示：**
```
[Index] ========== 点击提交按钮 ==========
[Index] 步骤1: 开始登录流程
[Auth] ========== 开始登录流程 ==========
[Auth] 用户已登录，检查code缓存
[Auth] 缓存的code有效，剩余时间: 180 秒
[Auth] 使用缓存的code，无需重新登录
[Auth] ========== 登录流程完成 ==========
[Index] 登录成功，获取到code: 071xxxxxxxxxxxxx （缓存）
```

**✅ 关键差异：**
- **没有** "开始调用wx.login" 日志
- **没有** "登录中..." 加载提示
- 直接跳转到info页面（几乎瞬间）
- 使用相同的code

**✅ 性能提升：**
- 响应时间从 800ms → <50ms
- 用户体验：即点即跳

---

### 场景3: Code过期测试（4-24小时）

**目的**: 验证code过期后自动刷新机制

#### 操作步骤

1. **模拟code过期**
   ```javascript
   // 微信开发者工具控制台执行
   const oldTimestamp = Date.now() - (5 * 60 * 1000) // 5分钟前
   wx.setStorageSync('wx_login_code_timestamp', oldTimestamp)
   console.log('code已模拟过期')
   ```

2. **刷新页面**

3. **点击"照见本心"按钮**

#### 预期结果

**✅ 控制台应该显示：**
```
[Auth] 用户已登录，检查code缓存
[Auth] 缓存的code已过期
[Auth] code已过期，重新获取
[Auth] 开始调用wx.login获取新的code
[Auth] 获取code成功: 082xxxxxxxxxxxxx （新code）
```

**✅ 关键特征：**
- 检测到登录状态仍然有效
- 但code缓存已过期
- 静默调用wx.login获取新code
- 用户无明显感知（可能有短暂加载）

---

### 场景4: 登录状态过期测试（超过24小时）

**目的**: 验证登录状态过期后的重新登录

#### 操作步骤

1. **模拟登录状态过期**
   ```javascript
   // 微信开发者工具控制台执行
   wx.removeStorageSync('wx_login_state')
   wx.removeStorageSync('wx_login_code')
   wx.removeStorageSync('wx_login_code_timestamp')
   console.log('登录状态已清除')
   ```

2. **刷新页面**

3. **点击"照见本心"按钮**

#### 预期结果

**✅ 行为同场景1：**
- 重新执行完整登录流程
- 显示"登录中..."提示
- 获取新的code
- 建立新的登录状态

---

### 场景5: 网络异常测试

**目的**: 验证错误处理机制

#### 操作步骤

1. **断开网络**
   - 微信开发者工具 → 右上角 → Network → Offline

2. **点击"照见本心"按钮**

#### 预期结果

**✅ 错误提示：**
- 显示弹窗: "登录失败，请重试"
- 控制台显示错误信息
- 不会跳转到info页面

**✅ 恢复测试：**
1. 恢复网络连接
2. 再次点击按钮
3. 应该正常登录

---

### 场景6: 后端接口联调测试

**目的**: 验证前后端完整流程

#### 操作步骤

1. **确保后端服务运行**
   ```bash
   # 查看后端日志应该有
   微信登录成功，OpenId: oxxxxxxxxxxxxxxxxxxxx
   ```

2. **执行场景1的登录流程**

3. **观察后端控制台**

#### 预期结果

**✅ 后端日志应该显示：**
```
接收到请求参数: {code: "071xxx", gender: "male", ...}
调用微信接口code2Session
微信登录成功，OpenId: oxxxxxxxxxxxxxx
缓存未命中，开始计算八字
调用Gemini AI分析
返回分析结果
```

**✅ 前端接收：**
- info页面正确显示八字信息
- 显示AI分析内容
- 没有报错

---

## 🔍 调试工具

### 1. 查看登录状态

在任意页面的控制台执行：
```javascript
const { authManager } = require('./utils/auth.js')
const loginInfo = authManager.getLoginInfo()
console.log('完整登录信息:', loginInfo)
```

**输出示例：**
```javascript
{
  isLoggedIn: true,
  loginState: {timestamp: 1734422400000, isLoggedIn: true},
  code: "071xxxxxxxxxxxxx",
  codeTimestamp: 1734422400000,
  codeValid: true
}
```

### 2. 手动登出

```javascript
const { authManager } = require('./utils/auth.js')
authManager.logout()
```

### 3. 强制刷新code

```javascript
const { authManager } = require('./utils/auth.js')
authManager.getLoginCode(true).then(code => {
  console.log('新code:', code)
})
```

### 4. 查看Storage

微信开发者工具 → Storage 面板 → 查看三个key：
- `wx_login_code`
- `wx_login_code_timestamp`
- `wx_login_state`

### 5. 查看Network请求

微信开发者工具 → Network 面板 → 找到 `analyze` 请求：
- 查看Request Headers (X-Timestamp, X-Sign)
- 查看Request Payload (code字段)
- 查看Response (200状态码)

---

## 📊 测试记录表

| 场景 | 测试时间 | 是否通过 | code值 | 备注 |
|------|---------|---------|--------|------|
| 首次登录 | | ⬜ | | |
| 缓存code | | ⬜ | | |
| code过期 | | ⬜ | | |
| 状态过期 | | ⬜ | | |
| 网络异常 | | ⬜ | | |
| 后端联调 | | ⬜ | | |

---

## ✅ 验收清单

### 功能验收
- [ ] 首次点击能成功调用wx.login
- [ ] 4分钟内再次点击使用缓存code
- [ ] code过期能自动刷新
- [ ] 登录状态能持久化24小时
- [ ] 网络异常有友好提示
- [ ] 后端能正确接收code
- [ ] 后端能成功换取openId
- [ ] 接口返回正确的分析结果

### 性能验收
- [ ] 首次登录响应时间 < 1秒
- [ ] 缓存登录响应时间 < 100ms
- [ ] wx.login调用次数减少75%以上
- [ ] 无明显卡顿或延迟

### 用户体验验收
- [ ] 已登录用户无感知（无弹窗）
- [ ] 首次登录有明确提示
- [ ] 错误提示清晰友好
- [ ] 页面跳转流畅自然

### 代码质量验收
- [ ] 控制台日志完整清晰
- [ ] 无报错和警告
- [ ] 代码注释充分
- [ ] 符合规范要求

---

## 🐛 问题排查

### 问题1: Storage中没有code

**可能原因：**
1. wx.login调用失败
2. code未正确缓存
3. 缓存被意外清除

**排查步骤：**
1. 查看控制台是否有错误
2. 检查authManager.saveCodeCache是否执行
3. 手动调用wx.setStorageSync测试

### 问题2: code传递到后端为空

**可能原因：**
1. 页面跳转URL拼接错误
2. info页面未正确接收参数

**排查步骤：**
1. 检查index.js中的navigateTo URL
2. 在info.js的onLoad中打印options
3. 确认code是否在URL参数中

### 问题3: 后端报"code无效"

**可能原因：**
1. code已被使用（微信code只能用一次）
2. code已过期（5分钟）
3. appid和secret配置错误

**排查步骤：**
1. 确认code是否重复使用
2. 检查code获取到使用的时间差
3. 验证后端微信配置

---

## 📝 测试注意事项

### 1. 测试环境
- 使用测试号AppID
- 开发者工具版本 ≥ 2.21.0
- 后端服务必须运行

### 2. 测试数据
- 性别、年月日时可任意组合
- code由wx.login自动生成
- 不要手动修改Storage中的code

### 3. 测试时机
- 每次代码修改后重新测试
- 发布前完整测试所有场景
- 真机测试前先开发者工具测试

### 4. 真机测试
- 真机测试前需配置合法域名
- 或开启"开发环境不校验域名"
- 建议先开发者工具验证再真机

---

**测试指南版本**: v1.0  
**更新时间**: 2025-12-17  
**适用版本**: 小程序基础库 2.21.0+
